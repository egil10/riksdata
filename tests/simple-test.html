<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Cache Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        canvas { max-width: 100%; height: 300px; }
    </style>
</head>
<body>
    <h1>Simple Cache Test</h1>
    <canvas id="test-chart"></canvas>
    <div id="status"></div>

    <script>
        // Copy the loadChartData function from scripts.js
        async function loadChartData(canvasId, apiUrl, chartTitle, chartType = 'line') {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    throw new Error(`Canvas with id '${canvasId}' not found`);
                }

                // Determine cache file path based on API URL
                let cachePath;
                if (apiUrl.includes('ssb.no')) {
                    // Extract dataset ID from SSB URL
                    const datasetId = apiUrl.match(/dataset\/(\d+)\.json/)?.[1];
                    if (!datasetId) {
                        throw new Error('Could not extract dataset ID from SSB URL');
                    }
                    
                    // Map dataset ID to cache filename
                    const datasetMap = {
                        '1086': 'cpi',
                        '1054': 'unemployment', 
                        '1060': 'house-prices',
                        '26426': 'ppi',
                        '1124': 'wage',
                        '59012': 'gdp-growth',
                        '58962': 'trade-balance',
                        '95265': 'bankruptcies',
                        '49626': 'population-growth',
                        '26944': 'construction-costs',
                        '27002': 'industrial-production',
                        '1064': 'retail-sales',
                        '179421': 'export-volume',
                        '166316': 'business-confidence',
                        '166330': 'consumer-confidence',
                        '95146': 'housing-starts',
                        '172769': 'monetary-aggregates',
                        '166328': 'job-vacancies',
                        '924808': 'construction-production',
                        '166326': 'credit-indicator',
                        '928196': 'energy-consumption',
                        '928194': 'government-revenue',
                        '924820': 'international-accounts',
                        '760065': 'labour-cost-index',
                        '1122': 'salmon-export',
                        '48651': 'immigration-rate',
                        '56900': 'household-income',
                        '102811': 'life-expectancy',
                        '97445': 'crime-rate',
                        '85454': 'education-level',
                        '65962': 'holiday-property-sales',
                        '832678': 'greenhouse-gas',
                        '934513': 'economic-forecasts',
                        '26158': 'new-dwellings-price',
                        '832683': 'lifestyle-habits',
                        '832685': 'long-term-illness',
                        '1104': 'population-growth-alt',
                        '1106': 'births-deaths',
                        '1118': 'cpi-ate',
                        '1120': 'salmon-export-volume',
                        '1126': 'basic-salary',
                        '1130': 'export-country',
                        '1132': 'import-country',
                        '1134': 'export-commodity',
                        '1140': 'import-commodity',
                        '1056': 'construction-cost-wood',
                        '1058': 'construction-cost-multi',
                        '1065': 'wholesale-retail',
                        '1068': 'household-types',
                        '1074': 'population-age',
                        '1084': 'cpi-coicop',
                        '1090': 'cpi-subgroups',
                        '1096': 'cpi-items',
                        '1100': 'cpi-delivery',
                        '56957': 'household-income-size',
                        '85440': 'cohabiting-arrangements',
                        '95177': 'utility-floor-space',
                        '166327': 'credit-indicator-c2',
                        '166329': 'job-vacancies-new',
                        '124322': 'oil-gas-turnover',
                        '179415': 'trade-volume-price',
                        '741023': 'producer-price-industry',
                        '567324': 'deaths-age',
                        '924809': 'construction-production-alt',
                        '924816': 'bankruptcies-total',
                        '928197': 'energy-accounts',
                        '172793': 'monetary-m3',
                        '25139': 'new-dwellings-price-alt',
                        '166317': 'business-tendency'
                    };
                    
                    const cacheName = datasetMap[datasetId];
                    if (!cacheName) {
                        throw new Error(`No cache mapping found for dataset ID: ${datasetId}`);
                    }
                    
                    cachePath = `data/cached/ssb/${cacheName}.json`;
                    
                } else if (apiUrl.includes('norges-bank.no')) {
                    // Map Norges Bank URLs to cache files
                    if (apiUrl.includes('EXR/M.USD+EUR.NOK.SP')) {
                        cachePath = 'data/cached/norges-bank/exchange-rates.json';
                    } else if (apiUrl.includes('IR/M.KPRA')) {
                        cachePath = 'data/cached/norges-bank/interest-rate.json';
                    } else if (apiUrl.includes('GOVT_KEYFIGURES')) {
                        cachePath = 'data/cached/norges-bank/government-debt.json';
                    } else {
                        throw new Error(`Unknown Norges Bank API URL: ${apiUrl}`);
                    }
                } else {
                    throw new Error(`Unknown data source: ${apiUrl}`);
                }

                // Fetch data from cache file
                const response = await fetch(cachePath);
                if (!response.ok) {
                    throw new Error(`Failed to load cached data: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                // Parse data based on source
                let parsedData;
                if (apiUrl.includes('ssb.no')) {
                    parsedData = parseSSBData(data, chartTitle);
                } else if (apiUrl.includes('norges-bank.no')) {
                    if (chartTitle.includes('Exchange Rate')) {
                        parsedData = parseExchangeRateData(data);
                    } else if (chartTitle.includes('Interest Rate')) {
                        parsedData = parseInterestRateData(data);
                    } else if (chartTitle.includes('Government Debt')) {
                        parsedData = parseGovernmentDebtData(data);
                    } else {
                        throw new Error(`Unknown Norges Bank chart type: ${chartTitle}`);
                    }
                } else {
                    throw new Error(`Unknown data source: ${apiUrl}`);
                }
                
                if (!parsedData || parsedData.length === 0) {
                    throw new Error('No data points after parsing');
                }
                
                // Filter data from 2000 onwards
                const filteredData = parsedData.filter(item => {
                    const year = new Date(item.date).getFullYear();
                    return year >= 2000;
                });

                if (filteredData.length === 0) {
                    throw new Error('No data available from 2000 onwards');
                }

                // Create simple chart
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: filteredData.map(d => d.date.toLocaleDateString()),
                        datasets: [{
                            label: chartTitle,
                            data: filteredData.map(d => d.value),
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });

                document.getElementById('status').innerHTML = '✅ Chart loaded successfully!';
                return true;

            } catch (error) {
                console.error(`Error loading data for ${canvasId} (${chartTitle}):`, error);
                document.getElementById('status').innerHTML = `❌ Error: ${error.message}`;
                return false;
            }
        }

        // Copy the parseSSBData function
        function parseSSBData(ssbData, chartTitle) {
            try {
                const dataset = ssbData.dataset;
                const dimension = dataset.dimension;
                const value = dataset.value;

                // Find time dimension
                const timeDimension = dimension.Tid;
                if (!timeDimension) {
                    throw new Error('Time dimension not found in SSB data');
                }

                // Get time labels and indices
                const timeLabels = timeDimension.category.label;
                const timeIndex = timeDimension.category.index;

                // Find the main data series
                let targetSeriesIndex = 0;
                let numSeries = 1;
                
                if (dimension.ContentsCode) {
                    const contentLabels = dimension.ContentsCode.category.label;
                    const contentIndices = dimension.ContentsCode.category.index;
                    
                    // Find the right content code based on the data type
                    let found = false;
                    for (const [key, label] of Object.entries(contentLabels)) {
                        if (label.includes('Consumer Price Index (2015=100)') || 
                            label.includes('Unemployment rate (LFS)') ||
                            label.includes('Producer Price Index') ||
                            label.includes('House Price Index') ||
                            label.includes('Wage Index') ||
                            label.includes('GDP') ||
                            label.includes('Trade balance') ||
                            label.includes('Bankruptcies') ||
                            label.includes('Population') ||
                            label.includes('Construction cost') ||
                            label.includes('Industrial production') ||
                            label.includes('Retail sales') ||
                            label.includes('Export') ||
                            label.includes('Import') ||
                            label.includes('Employment') ||
                            label.includes('Business confidence') ||
                            label.includes('Consumer confidence') ||
                            label.includes('Housing starts') ||
                            label.includes('Oil price') ||
                            label.includes('Monetary aggregates') ||
                            label.includes('Job vacancies') ||
                            label.includes('Household consumption') ||
                            label.includes('Credit indicator') ||
                            label.includes('Energy consumption') ||
                            label.includes('Government revenue') ||
                            label.includes('International accounts') ||
                            label.includes('Labour cost') ||
                            label.includes('R&D') ||
                            label.includes('Salmon export') ||
                            label.includes('Oil & gas investment') ||
                            label.includes('Immigration') ||
                            label.includes('Household income') ||
                            label.includes('Life expectancy') ||
                            label.includes('Crime rate') ||
                            label.includes('Education level') ||
                            label.includes('Holiday property') ||
                            label.includes('Greenhouse gas') ||
                            label.includes('Economic forecasts') ||
                            label.includes('New dwellings') ||
                            label.includes('Lifestyle habits') ||
                            label.includes('Long-term illness') ||
                            label.includes('Births and deaths') ||
                            label.includes('CPI-ATE') ||
                            label.includes('Basic salary') ||
                            label.includes('Export by country') ||
                            label.includes('Import by country') ||
                            label.includes('Export by commodity') ||
                            label.includes('Import by commodity') ||
                            label.includes('Construction cost wood') ||
                            label.includes('Construction cost multi') ||
                            label.includes('Wholesale retail') ||
                            label.includes('Household types') ||
                            label.includes('Population by age') ||
                            label.includes('CPI Coicop') ||
                            label.includes('CPI Sub-groups') ||
                            label.includes('CPI Items') ||
                            label.includes('CPI Delivery') ||
                            label.includes('Household income size') ||
                            label.includes('Cohabiting arrangements') ||
                            label.includes('Utility floor space') ||
                            label.includes('Oil gas turnover') ||
                            label.includes('Trade volume price') ||
                            label.includes('Producer price industry') ||
                            label.includes('Deaths by age') ||
                            label.includes('Energy accounts') ||
                            label.includes('Monetary M3') ||
                            label.includes('Business tendency')) {
                            targetSeriesIndex = contentIndices[key];
                            found = true;
                            break;
                        }
                    }
                    
                    // If no specific content code found, use the first one
                    if (!found && Object.keys(contentIndices).length > 0) {
                        const firstKey = Object.keys(contentIndices)[0];
                        targetSeriesIndex = contentIndices[firstKey];
                        console.log(`Using first content code for ${chartTitle}: ${contentLabels[firstKey]}`);
                    }
                    
                    numSeries = Object.keys(contentIndices).length;
                }

                // Parse data points
                const dataPoints = [];
                
                // Iterate through the time periods
                Object.keys(timeLabels).forEach(timeKey => {
                    const timeLabel = timeLabels[timeKey];
                    const timeIndexValue = timeIndex[timeKey];
                    
                    // Parse the time label (format: "2023M01" for monthly data)
                    const date = parseTimeLabel(timeLabel);
                    
                    if (date) {
                        // Calculate the correct index in the value array
                        // The array is organized by: [series1_time1, series2_time1, series3_time1, series1_time2, series2_time2, ...]
                        const valueIndex = timeIndexValue * numSeries + targetSeriesIndex;
                        
                        if (valueIndex < value.length) {
                            const dataValue = value[valueIndex];
                            
                            // Skip null, undefined, or zero values
                            if (dataValue !== undefined && dataValue !== null && dataValue !== 0) {
                                dataPoints.push({
                                    date: date,
                                    value: parseFloat(dataValue)
                                });
                            }
                        }
                    }
                });

                // Sort by date
                dataPoints.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                return dataPoints;

            } catch (error) {
                console.error('Error parsing SSB data:', error);
                throw new Error('Invalid SSB data format');
            }
        }

        // Copy the parseTimeLabel function
        function parseTimeLabel(timeLabel) {
            try {
                // Handle monthly format: "2023M01"
                if (timeLabel.includes('M')) {
                    const [year, month] = timeLabel.split('M');
                    return new Date(parseInt(year), parseInt(month) - 1, 1);
                }
                
                // Handle quarterly format: "2023K1", "2023K2", etc.
                if (timeLabel.includes('K')) {
                    const [year, quarter] = timeLabel.split('K');
                    const quarterNum = parseInt(quarter);
                    const month = (quarterNum - 1) * 3; // K1=Jan, K2=Apr, K3=Jul, K4=Oct
                    return new Date(parseInt(year), month, 1);
                }
                
                // Handle yearly format: "2023"
                if (/^\d{4}$/.test(timeLabel)) {
                    return new Date(parseInt(timeLabel), 0, 1);
                }
                
                // Handle other formats as needed
                return new Date(timeLabel);
                
            } catch (error) {
                console.error('Error parsing time label:', timeLabel, error);
                return null;
            }
        }

        // Test loading CPI data
        loadChartData('test-chart', 'https://data.ssb.no/api/v0/dataset/1086.json?lang=en', 'Consumer Price Index');
    </script>
</body>
</html>

