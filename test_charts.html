<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Debug Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <h1>Chart Debug Test</h1>
    <button onclick="testSingleChart()">Test Single Chart</button>
    <button onclick="debugAllCharts()">Debug All Charts</button>
    <div id="results"></div>

    <script>
        // Test a single chart to see what's happening
        async function testSingleChart() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>Testing CPI Chart...</h2>';
            
            try {
                const response = await fetch('https://data.ssb.no/api/v0/dataset/1086.json?lang=en');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Raw SSB data:', data);
                
                // Test parsing
                const parsedData = parseSSBData(data, 'Consumer Price Index');
                console.log('Parsed data:', parsedData);
                
                // Filter from 2000
                const filteredData = parsedData.filter(item => {
                    const year = new Date(item.date).getFullYear();
                    return year >= 2000;
                });
                
                console.log('Filtered data:', filteredData);
                
                resultsDiv.innerHTML += `<p>✅ Success! Found ${filteredData.length} data points from 2000 onwards.</p>`;
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML += `<p>❌ Error: ${error.message}</p>`;
            }
        }

        // Copy parsing functions from scripts.js
        function parseSSBData(ssbData, chartTitle) {
            try {
                const dataset = ssbData.dataset;
                const dimension = dataset.dimension;
                const value = dataset.value;

                const timeDimension = dimension.Tid;
                if (!timeDimension) {
                    throw new Error('Time dimension not found in SSB data');
                }

                const timeLabels = timeDimension.category.label;
                const timeIndex = timeDimension.category.index;

                let targetSeriesIndex = 0;
                let numSeries = 1;
                
                if (dimension.ContentsCode) {
                    const contentLabels = dimension.ContentsCode.category.label;
                    const contentIndices = dimension.ContentsCode.category.index;
                    
                    for (const [key, label] of Object.entries(contentLabels)) {
                        if (label.includes('Consumer Price Index (2015=100)') || 
                            label.includes('Unemployment rate (LFS)') ||
                            label.includes('Producer Price Index') ||
                            label.includes('House Price Index') ||
                            label.includes('Wage Index') ||
                            label.includes('GDP') ||
                            label.includes('Trade balance') ||
                            label.includes('Bankruptcies') ||
                            label.includes('Population') ||
                            label.includes('Construction cost')) {
                            targetSeriesIndex = contentIndices[key];
                            break;
                        }
                    }
                    numSeries = Object.keys(contentIndices).length;
                }

                const dataPoints = [];
                
                Object.keys(timeLabels).forEach(timeKey => {
                    const timeLabel = timeLabels[timeKey];
                    const timeIndexValue = timeIndex[timeKey];
                    
                    const date = parseTimeLabel(timeLabel);
                    
                    if (date) {
                        const valueIndex = timeIndexValue * numSeries + targetSeriesIndex;
                        
                        if (valueIndex < value.length) {
                            const dataValue = value[valueIndex];
                            
                            if (dataValue !== undefined && dataValue !== null && dataValue !== 0) {
                                dataPoints.push({
                                    date: date,
                                    value: parseFloat(dataValue)
                                });
                            }
                        }
                    }
                });

                dataPoints.sort((a, b) => new Date(a.date) - new Date(b.date));
                return dataPoints;

            } catch (error) {
                console.error('Error parsing SSB data:', error);
                throw new Error('Invalid SSB data format');
            }
        }

        function parseTimeLabel(timeLabel) {
            try {
                if (timeLabel.includes('M')) {
                    const [year, month] = timeLabel.split('M');
                    return new Date(parseInt(year), parseInt(month) - 1, 1);
                }
                
                if (timeLabel.includes('K')) {
                    const [year, quarter] = timeLabel.split('K');
                    const quarterNum = parseInt(quarter);
                    const month = (quarterNum - 1) * 3;
                    return new Date(parseInt(year), month, 1);
                }
                
                if (/^\d{4}$/.test(timeLabel)) {
                    return new Date(parseInt(timeLabel), 0, 1);
                }
                
                return new Date(timeLabel);
                
            } catch (error) {
                console.error('Error parsing time label:', timeLabel, error);
                return null;
            }
        }

        // Test Norges Bank data
        async function testNorgesBank() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>Testing Norges Bank Data...</h2>';
            
            try {
                const response = await fetch('https://data.norges-bank.no/api/data/EXR/M.USD+EUR.NOK.SP?format=sdmx-json&startPeriod=2015-08-11&endPeriod=2025-08-01&locale=no');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Raw Norges Bank data:', data);
                
                // Test the current parsing function
                const parsedData = parseExchangeRateData(data);
                console.log('Parsed Norges Bank data:', parsedData);
                
                resultsDiv.innerHTML += `<p>✅ Norges Bank: Found ${parsedData.length} data points.</p>`;
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML += `<p>❌ Norges Bank Error: ${error.message}</p>`;
            }
        }

        function parseExchangeRateData(data) {
            try {
                const dataPoints = [];
                const series = data.data.dataSets[0].series;
                
                console.log('Series keys:', Object.keys(series));
                
                // Parse USD/NOK (series 0:0:0:0)
                if (series['0:0:0:0'] && series['0:0:0:0'].observations) {
                    console.log('Observations:', series['0:0:0:0'].observations);
                    Object.keys(series['0:0:0:0'].observations).forEach(key => {
                        const value = series['0:0:0:0'].observations[key][0];
                        // Calculate proper date from index (starting from 2015-09)
                        const monthOffset = parseInt(key);
                        const month = 9 + monthOffset;
                        const year = 2015 + Math.floor((month - 1) / 12);
                        const actualMonth = ((month - 1) % 12) + 1;
                        const date = new Date(year, actualMonth - 1, 1);
                        dataPoints.push({
                            date: date,
                            value: parseFloat(value)
                        });
                    });
                }

                dataPoints.sort((a, b) => new Date(a.date) - new Date(b.date));
                return dataPoints;

            } catch (error) {
                console.error('Error parsing exchange rate data:', error);
                throw new Error('Invalid exchange rate data format');
            }
        }

        // Add button for Norges Bank test
        document.addEventListener('DOMContentLoaded', function() {
            const button = document.createElement('button');
            button.textContent = 'Test Norges Bank';
            button.onclick = testNorgesBank;
            document.body.insertBefore(button, document.getElementById('results'));
        });
    </script>
</body>
</html>
